<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è´¦ç›® Â· iBudget</title>
    <style>
        :root{
            --bg:#f7f8f9;
            --card:#ffffff;
            --text:#334455; /* ä»#0f172aè°ƒæ•´ä¸ºè¾ƒæµ…çš„#334455ï¼Œæå‡æµ…è‰²æ¨¡å¼å¯è¯»æ€§ */
            --muted:#64748b;
            --line:#e5e7eb;
            --accent:#0a84ff;
            --warn:#d33
        }
        [data-theme="dark"]{
            --bg:#0f172a;
            --card:#1e293b;
            --text:#f8fafc; /* æ·±è‰²æ¨¡å¼ä¿æŒä¸å˜ */
            --muted:#94a3b8;
            --line:#334155;
            --accent:#38bdf8;
            --warn:#ef4444
        }

        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,system-ui}
        .container{max-width:1080px;margin:0 auto;padding:24px}
        .header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
        .nav a{color:var(--muted);text-decoration:none;margin-left:12px}
        .surface{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
        .section-title{display:flex;align-items:center;gap:8px;margin:0 0 12px 0;font-size:16px;font-weight:600}
        .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
        .grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}

        label{font-size:12px;color:var(--muted);font-weight: 600; margin-bottom: 4px; display: block;}

        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff;color:var(--text);font-size: 14px;}
        [data-theme="dark"] input, [data-theme="dark"] select { background: #0f172a; }
        input:focus{border-color:var(--accent);box-shadow: 0 0 0 2px rgba(56,189,248,0.2)}

        /* æ—¥å†æµ®çª—æ ·å¼ */
        .datepicker-popover {
            position: absolute;
            z-index: 1000;
            width: 280px;
            background: var(--card);
            border: 2px solid var(--line);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: none;
        }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-head { font-size: 11px; color: var(--muted); padding: 5px 0; font-weight: 700; }
        .cal-date { padding: 8px 0; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 13px; color: var(--text); border: 1px solid transparent; }
        .cal-date:hover { background: var(--bg); border-color: var(--accent); }

        .cal-today {
            color: var(--accent) !important;
            font-weight: 800 !important;
            background: rgba(56, 189, 248, 0.15);
            border: 1.5px solid var(--accent) !important;
        }

        .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight: 600}
        [data-theme="dark"] .btn:not(.btn-primary) { background: #1e293b; }
        .btn-primary{background:var(--accent);border-color:var(--accent);color:#0f172a}
        .toggle-group{display:flex;gap:0;border-radius:12px;overflow:hidden;border:1px solid var(--line);width:100%;height:44px}
        .toggle-btn{flex:1;padding:0;background:var(--bg);color:var(--muted);border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s ease;border-right:1px solid var(--line);display:flex;align-items:center;justify-content:center}
        .toggle-btn:last-child{border-right:none}
        .toggle-btn.active{background:var(--accent);color:#fff;box-shadow:inset 0 0 0 2px var(--accent)}
        .toggle-btn:hover:not(.active){background:var(--card);color:var(--text)}

        .hint { font-size: 10px; color: var(--muted); margin-top: 4px; }
    </style>
</head>
<body>

<div id="calendarPopover" class="datepicker-popover">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <button class="btn" style="padding: 4px 10px" id="calPrevMonth">Â«</button>
        <div id="calHeader" style="font-weight: 800; font-size: 14px; color: var(--text);"></div>
        <button class="btn" style="padding: 4px 10px" id="calNextMonth">Â»</button>
    </div>
    <div class="cal-grid">
        <div class="cal-day-head">ä¸€</div><div class="cal-day-head">äºŒ</div><div class="cal-day-head">ä¸‰</div>
        <div class="cal-day-head">å››</div><div class="cal-day-head">äº”</div><div class="cal-day-head">å…­</div>
        <div class="cal-day-head">æ—¥</div>
    </div>
    <div class="cal-grid" id="calGridDays"></div>
</div>

<div class="container">
    <div class="header">
        <div style="font-weight:800;font-size:1.2rem">iBudget</div>
        <div class="nav">
            <a href="/transactions.html">è´¦ç›®</a>
            <a href="/budgets.html">é¢„ç®—</a>
            <a href="/trends.html">è¶‹åŠ¿</a>
            <a href="/charts.html">å›¾è¡¨</a>
            <a href="/login.html">åˆ‡æ¢è´¦å·</a>
            <a href="#" id="themeToggle" style="color:var(--accent);font-weight:800">åˆ‡æ¢ä¸»é¢˜</a>
        </div>
    </div>

    <div class="surface" style="margin-bottom:16px">
        <div class="section-title">ğŸ“ æ–°å¢/ç¼–è¾‘è´¦ç›®</div>
        <div class="grid-3">
            <div>
                <label>ç±»å‹</label>
                <div class="toggle-group" style="margin-top:6px">
                    <button class="toggle-btn active" data-value="EXPENSE">æ”¯å‡º</button>
                    <button class="toggle-btn" data-value="INCOME">æ”¶å…¥</button>
                </div>
            </div>
            <div><label>é‡‘é¢</label><input id="txAmount" type="number" min="0"></div>
            <div><label>åˆ†ç±»</label><input id="txCategory"></div>
            <div style="grid-column:1/-1"><label>æè¿°</label><input id="txDesc"></div>
            <div style="grid-column:1/-1">
                <label>æ—¥æœŸä¸æ—¶é—´ (å¯ç‚¹å‡»æ—¥å†åæ‰‹åŠ¨ä¿®æ”¹ T åçš„æ•°å€¼)</label>
                <input id="txDate" class="dt-trigger" placeholder="YYYY-MM-DDTHH:mm:ss">
                <div class="hint">ç¤ºä¾‹æ ¼å¼ï¼š2025-12-23T14:30:00</div>
            </div>
        </div>
        <div style="margin-top:16px; display:flex; gap:12px;">
            <button class="btn btn-primary" id="btnSaveTx">ä¿å­˜è´¦ç›®</button>
            <button class="btn" id="btnResetTx">é‡ç½®è¾“å…¥</button>
        </div>
    </div>

    <div class="surface" style="margin-bottom:16px">
        <div class="section-title">ğŸ” æŸ¥è¯¢è¿‡æ»¤</div>
        <div class="grid-4">
            <div><label>å¼€å§‹æ—¶é—´</label><input id="fStart" class="dt-trigger" placeholder="èµ·å§‹æ—¶é—´"></div>
            <div><label>ç»“æŸæ—¶é—´</label><input id="fEnd" class="dt-trigger" placeholder="ç»“æŸæ—¶é—´"></div>
            <div><label>åˆ†ç±»æœç´¢</label><input id="fCategory" placeholder="è¾“å…¥åˆ†ç±»"></div>
            <div>
                <label>ç±»å‹</label>
                <div class="toggle-group" style="margin-top:6px">
                    <button class="toggle-btn active" data-value="">å…¨éƒ¨</button>
                    <button class="toggle-btn" data-value="EXPENSE">æ”¯å‡º</button>
                    <button class="toggle-btn" data-value="INCOME">æ”¶å…¥</button>
                </div>
            </div>
        </div>
        <div class="hint" style="margin-top:8px;margin-bottom:8px">æç¤º:æ—¥æœŸç­›é€‰éœ€è¦åŒæ—¶å¡«å†™å¼€å§‹å’Œç»“æŸæ—¶é—´,æ ¼å¼: YYYY-MM-DDTHH:mm:ss</div>
        <div style="margin-top:16px; display:flex; gap:12px;">
            <button class="btn btn-primary" id="btnApplyFilters">æ‰§è¡Œç­›é€‰</button>
            <button class="btn" id="btnClearFilters">é‡ç½®ç­›é€‰</button>
        </div>
    </div>
</div>

<script>
    let displayDate = new Date();
    let activeInput = null;
    const popover = document.getElementById('calendarPopover');

    function renderCalendar() {
        const grid = document.getElementById('calGridDays');
        const header = document.getElementById('calHeader');
        grid.innerHTML = '';
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        header.innerText = `${year}å¹´ ${month + 1}æœˆ`;

        const now = new Date();
        const firstDay = new Date(year, month, 1).getDay();
        const startOffset = firstDay === 0 ? 6 : firstDay - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startOffset; i++) grid.appendChild(document.createElement('div'));

        for (let d = 1; d <= daysInMonth; d++) {
            const div = document.createElement('div');
            div.className = 'cal-date';
            if (year === now.getFullYear() && month === now.getMonth() && d === now.getDate()) div.classList.add('cal-today');
            div.innerText = d;

            div.onclick = (e) => {
                e.stopPropagation();
                const datePart = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // æ™ºèƒ½ä¿ç•™æ—¶é—´é€»è¾‘ï¼šå¦‚æœç”¨æˆ·å·²ç»è¾“å…¥äº†æ—¶é—´ï¼Œä¿ç•™å®ƒï¼›å¦åˆ™é»˜è®¤12ç‚¹
                let timePart = "12:00:00";
                if (activeInput.value && activeInput.value.includes('T')) {
                    const parts = activeInput.value.split('T');
                    if (parts[1]) timePart = parts[1];
                }

                activeInput.value = `${datePart}T${timePart}`;
                hideCalendar();
                activeInput.focus(); // é€‰ä¸­åç„¦ç‚¹å›åˆ°è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿é”®å…¥æ—¶åˆ†ç§’
            };
            grid.appendChild(div);
        }
    }

    function showCalendar(input) {
        activeInput = input;
        const rect = input.getBoundingClientRect();
        popover.style.display = 'block';
        popover.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        popover.style.left = (rect.left + window.scrollX) + 'px';
        renderCalendar();
    }

    function hideCalendar() { popover.style.display = 'none'; }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä½†ä¸é”å®šè¾“å…¥ï¼ˆå»æ‰äº† readonlyï¼‰
    document.querySelectorAll('.dt-trigger').forEach(el => {
        el.onclick = (e) => { e.stopPropagation(); showCalendar(el); };
    });

    document.addEventListener('click', (e) => {
        if (!popover.contains(e.target) && !e.target.classList.contains('dt-trigger')) hideCalendar();
    });

    document.getElementById('calPrevMonth').onclick = (e) => { e.stopPropagation(); displayDate.setMonth(displayDate.getMonth() - 1); renderCalendar(); };
    document.getElementById('calNextMonth').onclick = (e) => { e.stopPropagation(); displayDate.setMonth(displayDate.getMonth() + 1); renderCalendar(); };

    document.getElementById('themeToggle').onclick=(e)=>{
        e.preventDefault();
        const t = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = t;
        localStorage.setItem('theme', t);
    };
    document.documentElement.dataset.theme = localStorage.getItem('theme') || 'light';

    // APIåŸºç¡€é…ç½®
    const base = '/api';
    const token = localStorage.getItem('jwt');
    if (!token) { location.href = '/login.html'; }

    async function fetchJSON(url, opts) {
        const r = await fetch(url, { ...opts, headers: { ...(opts && opts.headers || {}), 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token } });
        if (r.status === 403) {
            alert('ç™»å½•å·²è¿‡æœŸ,è¯·é‡æ–°ç™»å½•');
            localStorage.removeItem('jwt');
            location.href = '/login.html';
            throw new Error('èº«ä»½éªŒè¯å¤±è´¥');
        }
        if (!r.ok) throw new Error('http ' + r.status);
        return r.status === 204 ? null : await r.json();
    }

    // è·å–DOMå…ƒç´ 
    const txAmount = document.getElementById('txAmount');
    const txCategory = document.getElementById('txCategory');
    const txDesc = document.getElementById('txDesc');
    const txDate = document.getElementById('txDate');
    const fStart = document.getElementById('fStart');
    const fEnd = document.getElementById('fEnd');
    const fCategory = document.getElementById('fCategory');

    // é‡‘é¢æ ¸å¿ƒæ§åˆ¶ï¼šéè´Ÿã€æœ€å¤šä¸¤ä½å°æ•°ã€åŠ¨æ€ç²¾åº¦
    txAmount.oninput = () => {
        let val = txAmount.value;

        // 1. é™åˆ¶æœ€å¤šä¸¤ä½å°æ•°
        if (val.includes('.')) {
            const parts = val.split('.');
            if (parts[1].length > 2) {
                val = parts[0] + '.' + parts[1].slice(0, 2);
                txAmount.value = val;
            }
        }

        // 2. åŠ¨æ€è°ƒæ•´ç®­å¤´å¢å‡ç²¾åº¦ (Step)
        if (!val || !val.includes('.')) {
            txAmount.step = "1";
        } else {
            const decimalLen = val.split('.')[1].length;
            // å¦‚æœæœ‰ä¸€ä½å°æ•°ï¼Œæ­¥é•¿0.1ï¼›æœ‰ä¸¤ä½ï¼Œæ­¥é•¿0.01
            txAmount.step = Math.pow(10, -decimalLen).toString();
        }
    };

    txAmount.onchange = () => {
        // ç¦»å¼€ç„¦ç‚¹æ—¶ï¼Œå¦‚æœæ˜¯è´Ÿæ•°å¼ºåˆ¶å½’é›¶
        if (parseFloat(txAmount.value) < 0) {
            txAmount.value = 0;
        }
    };
    txAmount.step = "1"; // é»˜è®¤åˆå§‹æ­¥è¿›

    let editingId = null;
    let txTypeValue = 'EXPENSE'; // è´¦ç›®ç±»å‹
    let fTypeValue = ''; // ç­›é€‰ç±»å‹

    // è´¦ç›®ç±»å‹åˆ‡æ¢æŒ‰é’®
    document.querySelectorAll('.surface')[0].querySelectorAll('.toggle-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.surface')[0].querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            txTypeValue = btn.getAttribute('data-value');
        };
    });

    // ç­›é€‰ç±»å‹åˆ‡æ¢æŒ‰é’®
    document.querySelectorAll('.surface')[1].querySelectorAll('.toggle-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.surface')[1].querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            fTypeValue = btn.getAttribute('data-value');
        };
    });

    // ä¿å­˜è´¦ç›®
    document.getElementById('btnSaveTx').onclick = async () => {
        try {
            const amountVal = parseFloat(txAmount.value || '0');
            if (amountVal < 0) {
                alert('âŒ é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            }
            const payload = {
                type: txTypeValue,
                amount: amountVal,
                categoryId: txCategory.value || null,
                description: txDesc.value || '',
                date: txDate.value ? txDate.value : null
            };

            if (editingId) {
                await fetchJSON(base + '/transactions/' + editingId, { method: 'PUT', body: JSON.stringify(payload) });
                alert('âœ… è´¦ç›®æ›´æ–°æˆåŠŸ');
            } else {
                await fetchJSON(base + '/transactions', { method: 'POST', body: JSON.stringify(payload) });
                alert('âœ… è´¦ç›®æ·»åŠ æˆåŠŸ');
            }

            // é‡ç½®è¡¨å•
            editingId = null;
            txTypeValue = 'EXPENSE';
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.surface')[0].querySelectorAll('.toggle-btn').forEach((b, i) => {
                if (i === 0) b.classList.add('active');
                else b.classList.remove('active');
            });
            txAmount.value = '';
            txAmount.step = "1";
            txCategory.value = '';
            txDesc.value = '';
            txDate.value = '';

            // é‡æ–°åŠ è½½è´¦ç›®åˆ—è¡¨
            loadTransactions();
        } catch (e) {
            alert('âŒ ä¿å­˜å¤±è´¥: ' + e.message);
        }
    };

    // é‡ç½®è¡¨å•
    document.getElementById('btnResetTx').onclick = () => {
        editingId = null;
        txTypeValue = 'EXPENSE';
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.surface')[0].querySelectorAll('.toggle-btn').forEach((b, i) => {
            if (i === 0) b.classList.add('active');
            else b.classList.remove('active');
        });
        txAmount.value = '';
        txAmount.step = "1";
        txCategory.value = '';
        txDesc.value = '';
        txDate.value = '';
    };

    // åŠ è½½è´¦ç›®åˆ—è¡¨
    async function loadTransactions() {
        try {
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            if (fStart.value) {
                // ç¡®ä¿æ—¶é—´æ ¼å¼æ­£ç¡®
                if (!fStart.value.includes('T')) {
                    alert('âŒ å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®,éœ€è¦åŒ…å«æ—¶é—´éƒ¨åˆ†(å¦‚: 2025-12-01T00:00:00)');
                    return;
                }
                params.set('start', fStart.value);
            }
            if (fEnd.value) {
                if (!fEnd.value.includes('T')) {
                    alert('âŒ ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®,éœ€è¦åŒ…å«æ—¶é—´éƒ¨åˆ†(å¦‚: 2025-12-31T23:59:59)');
                    return;
                }
                params.set('end', fEnd.value);
            }
            // æ³¨æ„:åç«¯éœ€è¦åŒæ—¶æä¾›startå’Œendæ‰èƒ½è¿›è¡Œæ—¥æœŸç­›é€‰
            if ((fStart.value && !fEnd.value) || (!fStart.value && fEnd.value)) {
                alert('âš ï¸ æ—¥æœŸç­›é€‰éœ€è¦åŒæ—¶å¡«å†™å¼€å§‹å’Œç»“æŸæ—¶é—´');
                return;
            }
            if (fCategory.value) params.set('categoryId', fCategory.value);
            if (fTypeValue) params.set('type', fTypeValue);

            const url = params.toString() ? base + '/transactions?' + params.toString() : base + '/transactions';
            console.log('æŸ¥è¯¢URL:', url);
            const arr = await fetchJSON(url);

            // åˆ›å»ºè¡¨æ ¼æ˜¾ç¤º(å¦‚æœæ²¡æœ‰è¡¨æ ¼å®¹å™¨,å…ˆåˆ›å»ºä¸€ä¸ª)
            let container = document.getElementById('txListContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'txListContainer';
                container.className = 'surface';
                container.style.marginBottom = '16px';
                document.querySelector('.container').appendChild(container);
            }

            if (!arr || arr.length === 0) {
                container.innerHTML = '<div class="section-title">ğŸ“Š è´¦ç›®åˆ—è¡¨</div><p style="color:var(--muted);text-align:center;padding:20px">æš‚æ— è´¦ç›®æ•°æ®</p>';
                return;
            }

            container.innerHTML = `
                <div class="section-title">ğŸ“Š è´¦ç›®åˆ—è¡¨ (${arr.length}æ¡)</div>
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="border-bottom:1px solid var(--line)">
                            <th style="padding:12px;text-align:left;color:var(--muted);font-weight:600">ç±»å‹</th>
                            <th style="padding:12px;text-align:left;color:var(--muted);font-weight:600">é‡‘é¢</th>
                            <th style="padding:12px;text-align:left;color:var(--muted);font-weight:600">åˆ†ç±»</th>
                            <th style="padding:12px;text-align:left;color:var(--muted);font-weight:600">æè¿°</th>
                            <th style="padding:12px;text-align:left;color:var(--muted);font-weight:600">æ—¥æœŸ</th>
                            <th style="padding:12px;text-align:center;color:var(--muted);font-weight:600">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="txTbody"></tbody>
                </table>
            `;

            const tbody = document.getElementById('txTbody');
            tbody.innerHTML = arr.map(tx => {
                const typeColor = tx.type === 'EXPENSE' ? '#ef4444' : '#10b981';
                const typeText = tx.type === 'EXPENSE' ? 'æ”¯å‡º' : 'æ”¶å…¥';
                return `<tr style="border-bottom:1px solid var(--line)">
                    <td style="padding:12px;color:${typeColor};font-weight:600">${typeText}</td>
                    <td style="padding:12px;font-weight:600">Â¥${(tx.amount || 0).toFixed(2)}</td>
                    <td style="padding:12px">${tx.categoryId || '-'}</td>
                    <td style="padding:12px;color:var(--muted)">${tx.description || '-'}</td>
                    <td style="padding:12px;font-size:13px">${tx.date ? tx.date.replace('T', ' ') : '-'}</td>
                    <td style="padding:12px;text-align:center">
                        <button class="btn" style="padding:6px 12px;font-size:12px" data-id="${tx.id}" data-action="edit">ç¼–è¾‘</button>
                        <button class="btn" style="padding:6px 12px;font-size:12px;margin-left:4px" data-id="${tx.id}" data-action="del">åˆ é™¤</button>
                    </td>
                </tr>`;
            }).join('');

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            tbody.onclick = async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');

                if (action === 'edit') {
                    const tx = arr.find(t => t.id === id);
                    if (tx) {
                        editingId = id;
                        txTypeValue = tx.type;
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.querySelectorAll('.surface')[0].querySelectorAll('.toggle-btn').forEach(b => {
                            if (b.getAttribute('data-value') === tx.type) {
                                b.classList.add('active');
                            } else {
                                b.classList.remove('active');
                            }
                        });
                        txAmount.value = tx.amount;
                        txCategory.value = tx.categoryId || '';
                        txDesc.value = tx.description || '';
                        txDate.value = tx.date || '';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        // è§¦å‘ç²¾åº¦æ§åˆ¶é€»è¾‘
                        txAmount.oninput();
                    }
                } else if (action === 'del') {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦ç›®å—?')) {
                        await fetch(base + '/transactions/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                        alert('âœ… åˆ é™¤æˆåŠŸ');
                        loadTransactions();
                    }
                }
            };
        } catch (e) {
            console.error('åŠ è½½è´¦ç›®å¤±è´¥:', e);
            alert('åŠ è½½è´¦ç›®å¤±è´¥: ' + e.message);
        }
    }

    // ç­›é€‰æŒ‰é’®
    document.getElementById('btnApplyFilters').onclick = () => {
        console.log('æ‰§è¡Œç­›é€‰:', {
            start: fStart.value,
            end: fEnd.value,
            category: fCategory.value,
            type: fTypeValue
        });
        loadTransactions();
    };

    document.getElementById('btnClearFilters').onclick = () => {
        fStart.value = '';
        fEnd.value = '';
        fCategory.value = '';
        fTypeValue = '';
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.surface')[1].querySelectorAll('.toggle-btn').forEach((b, i) => {
            if (i === 0) b.classList.add('active');
            else b.classList.remove('active');
        });
        loadTransactions();
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è´¦ç›®
    loadTransactions();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>账目 · iBudget</title>
<style>
:root{--bg:#f7f8f9;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#0a84ff}
[data-theme="dark"]{--bg:#0b0e11;--card:#12151a;--text:#e5e7eb;--muted:#94a3b8;--line:#2a2f37;--accent:#0a84ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,system-ui}
.container{max-width:1080px;margin:0 auto;padding:24px}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
.nav a{color:var(--muted);text-decoration:none;margin-left:12px}
.surface{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
.section-title{display:flex;align-items:center;gap:8px;margin:0 0 12px 0;font-size:16px;font-weight:600}
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
label{font-size:12px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff}
input:focus,select:focus{border-color:var(--accent)}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.stack{display:flex;gap:10px;flex-wrap:wrap}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-weight:600;color:var(--muted);text-align:left;padding:8px 10px}
.table td{background:#fff;border:1px solid var(--line);border-left:none;border-right:none;padding:12px 10px}
.table tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
.table tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
@media (max-width:768px){.grid-3{grid-template-columns:1fr}.grid-4{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>iBudget</div>
    <div class="nav">
      <a href="/transactions.html">账目</a>
      <a href="/budgets.html">预算</a>
      <a href="/trends.html">趋势</a>
      <a href="/charts.html">图表</a>
      <a href="/login.html">切换账号</a>
      <a href="#" id="themeToggle">暗色</a>
    </div>
  </div>

  <div class="surface" style="margin-bottom:16px">
    <div class="section-title">本月概览</div>
    <div class="grid-4">
      <div><label>净额</label><input id="sumNet" disabled></div>
      <div><label>总收入</label><input id="sumInc" disabled></div>
      <div><label>总支出</label><input id="sumExp" disabled></div>
      <div><label>预算使用率</label><input id="sumRate" disabled></div>
    </div>
    <div class="stack" style="margin-top:8px">
      <button class="btn" id="btnRefreshSummary">刷新概览</button>
    </div>
  </div>

  <div class="surface" style="margin-bottom:16px">
    <div class="section-title">新增/编辑账目</div>
    <div class="grid-3">
      <div><label>类型</label><select id="txType"><option value="EXPENSE">支出</option><option value="INCOME">收入</option></select></div>
      <div><label>金额</label><input id="txAmount" type="number" step="0.01"></div>
      <div><label>分类</label><input id="txCategory"></div>
      <div style="grid-column:1/-1"><label>描述</label><input id="txDesc"></div>
      <div style="grid-column:1/-1"><label>日期(ISO)</label><input id="txDate" placeholder="2025-01-01T12:00:00"></div>
    </div>
    <div class="stack" style="margin-top:12px">
      <button class="btn btn-primary" id="btnSaveTx">保存</button>
      <button class="btn" id="btnResetTx">重置</button>
    </div>
  </div>

  <div class="surface">
    <div class="section-title">分类与过滤</div>
    <div class="grid-4" style="margin-bottom:10px">
      <div><label>分类</label><input id="fCategory"></div>
      <div><label>类型</label><select id="fType"><option value="">全部</option><option value="EXPENSE">支出</option><option value="INCOME">收入</option></select></div>
      <div><label>金额下限</label><input id="fMin" type="number" step="0.01"></div>
      <div><label>金额上限</label><input id="fMax" type="number" step="0.01"></div>
      <div><label>开始时间</label><input id="fStart" placeholder="2025-01-01T00:00:00"></div>
      <div><label>结束时间</label><input id="fEnd" placeholder="2025-01-31T23:59:59"></div>
      <div style="grid-column:1/-1"><label>关键字</label><input id="fQ" placeholder="描述或标签"></div>
    </div>
    <div class="stack">
      <button class="btn btn-primary" id="btnApplyFilters">应用过滤</button>
      <button class="btn" id="btnClearFilters">清除过滤</button>
    </div>
  </div>

  <div class="surface" style="margin-top:16px">
    <div class="section-title">账目列表</div>
    <table class="table">
      <thead><tr><th>类型</th><th>金额</th><th>分类</th><th>描述</th><th>日期</th><th>操作</th></tr></thead>
      <tbody id="txTbody"></tbody>
    </table>
  </div>
</div>

<script>
const savedTheme=localStorage.getItem('theme')||'light'
document.documentElement.dataset.theme=savedTheme
document.getElementById('themeToggle').onclick=(e)=>{e.preventDefault();const t=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=t;localStorage.setItem('theme',t)}
const base='/api'
const token=localStorage.getItem('jwt'); if(!token){location.href='/login.html'}
let editingId=null

async function fetchJSON(url,opts){
  const r=await fetch(url,{...opts,headers:{...(opts&&opts.headers||{}),'Content-Type':'application/json','Authorization':'Bearer '+token}})
  if(!r.ok) throw new Error('http '+r.status)
  return r.status===204?null:await r.json()
}

const txTbody=document.getElementById('txTbody')
const txType=document.getElementById('txType')
const txAmount=document.getElementById('txAmount')
const txCategory=document.getElementById('txCategory')
const txDesc=document.getElementById('txDesc')
const txDate=document.getElementById('txDate')

const fCategory=document.getElementById('fCategory')
const fType=document.getElementById('fType')
const fMin=document.getElementById('fMin')
const fMax=document.getElementById('fMax')
const fStart=document.getElementById('fStart')
const fEnd=document.getElementById('fEnd')
const fQ=document.getElementById('fQ')
const sumNet=document.getElementById('sumNet')
const sumInc=document.getElementById('sumInc')
const sumExp=document.getElementById('sumExp')
const sumRate=document.getElementById('sumRate')

function buildQuery(){
  const p=new URLSearchParams()
  if(fCategory.value) p.set('categoryId',fCategory.value)
  if(fType.value) p.set('type',fType.value)
  if(fMin.value) p.set('min',fMin.value)
  if(fMax.value) p.set('max',fMax.value)
  if(fStart.value && fEnd.value){p.set('start',fStart.value);p.set('end',fEnd.value)}
  if(fQ.value) p.set('q',fQ.value)
  const q=p.toString(); return q?('?'+q):''
}

async function loadTransactions(){
  try{
    const arr=await fetchJSON(base+'/transactions'+buildQuery())
    txTbody.innerHTML=arr.map(t=>`<tr>
      <td>${t.type}</td>
      <td style='text-align:right'>${(t.amount||0).toFixed(2)}</td>
      <td>${t.categoryId||''}</td>
      <td>${(t.description||'').replace(/</g,'&lt;')}</td>
      <td>${t.date||''}</td>
      <td>
        <button class='btn' data-id='${t.id}' data-action='edit'>编辑</button>
        <button class='btn' data-id='${t.id}' data-action='del'>删除</button>
      </td>
    </tr>`).join('')
  }catch{txTbody.innerHTML='<tr><td colspan="6">加载失败</td></tr>'}
}

function nowYM(){const d=new Date(); return {year:d.getFullYear(),month:d.getMonth()+1}}
async function loadSummary(){
  try{
    const ym=nowYM()
    const ms=await fetchJSON(base+`/stats/month?year=${ym.year}&month=${ym.month}`)
    sumNet.value=(ms.netAmount||0).toFixed(2)
    sumInc.value=(ms.totalIncome||0).toFixed(2)
    sumExp.value=(ms.totalExpense||0).toFixed(2)
    const bu=await fetchJSON(base+`/budgets/usage?year=${ym.year}&month=${ym.month}`)
    sumRate.value=(Math.round(((bu.rate||0)*1000))/10)+'%'
  }catch{}
}

txTbody.onclick=async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return
  const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action')
  if(action==='edit'){
    const t=await fetchJSON(base+'/transactions/'+id)
    editingId=id
    txType.value=t.type; txAmount.value=t.amount; txCategory.value=t.categoryId||''; txDesc.value=t.description||''; txDate.value=(t.date||'')
    window.scrollTo({top:0,behavior:'smooth'})
  } else if(action==='del'){
    await fetch(base+'/transactions/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}})
    loadTransactions();
    try{localStorage.setItem('ledgerLastUpdate', String(Date.now()))}catch{}
    try{loadSummary()}catch{}
  }
}

document.getElementById('btnSaveTx').onclick=async()=>{
  const payload={type:txType.value,amount:parseFloat(txAmount.value||'0'),categoryId:txCategory.value||null,description:txDesc.value||'',date:txDate.value?txDate.value:null}
  if(editingId){
    await fetchJSON(base+'/transactions/'+editingId,{method:'PUT',body:JSON.stringify(payload)})
  }else{
    await fetchJSON(base+'/transactions',{method:'POST',body:JSON.stringify(payload)})
  }
  editingId=null; txType.value='EXPENSE'; txAmount.value=''; txCategory.value=''; txDesc.value=''; txDate.value=''
  loadTransactions();
  try{localStorage.setItem('ledgerLastUpdate', String(Date.now()))}catch{}
  try{loadSummary()}catch{}
}
document.getElementById('btnResetTx').onclick=()=>{editingId=null; txType.value='EXPENSE'; txAmount.value=''; txCategory.value=''; txDesc.value=''; txDate.value=''}

document.getElementById('btnApplyFilters').onclick=()=>loadTransactions()
document.getElementById('btnClearFilters').onclick=()=>{fCategory.value='';fType.value='';fMin.value='';fMax.value='';fStart.value='';fEnd.value='';fQ.value='';loadTransactions()}
document.getElementById('btnRefreshSummary').onclick=()=>loadSummary()

loadTransactions(); loadSummary()
</script>
</body>
</html>

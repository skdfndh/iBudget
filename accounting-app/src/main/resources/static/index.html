<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>记账软件 Web 控制台</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;padding:20px}
h2{margin-top:24px}
input,button,textarea,select{margin:4px;padding:6px}
table{border-collapse:collapse;width:100%;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
.row{display:flex;gap:8px;flex-wrap:wrap}
.card{border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:12px}
.ok{color:#0a8}
.err{color:#d33}
</style>
</head>
<body>
<h1>记账软件 Web 控制台</h1>
<div class="card">
  <h2>账号</h2>
  <div class="row">
    <input id="username" placeholder="用户名">
    <input id="email" placeholder="邮箱">
    <input id="password" placeholder="密码" type="password">
  </div>
  <div class="row">
    <button id="btnRegister">注册</button>
    <button id="btnLogin">登录</button>
    <span id="authStatus">未登录</span>
  </div>
</div>

<div class="card">
  <h2>交易同步</h2>
  <div class="row">
    <button id="btnPull">拉取远端</button>
    <button id="btnPush">上传本地</button>
  </div>
  <div class="row">
    <textarea id="uploadArea" placeholder='上传 JSON 数组，例如 [{"type":"EXPENSE","amount":12.3,"categoryId":"food","description":"午餐","date":"2025-01-01T12:00:00"}]' rows="6" style="width:100%"></textarea>
  </div>
  <div class="row">
    <button id="btnUploadArea">从上方 JSON 上传</button>
  </div>
  <h3>交易列表</h3>
  <table>
    <thead><tr><th>类型</th><th>金额</th><th>分类</th><th>描述</th><th>日期</th></tr></thead>
    <tbody id="txTbody"></tbody>
  </table>
</div>

<div class="card">
  <h2>API 文档</h2>
  <div class="row">
    <a href="/swagger-ui.html" target="_blank">打开 Swagger UI</a>
  </div>
</div>

<script>
const state={token:null,base:'/api'};
const username=document.getElementById('username');
const email=document.getElementById('email');
const password=document.getElementById('password');
const authStatus=document.getElementById('authStatus');
const txTbody=document.getElementById('txTbody');
document.getElementById('btnRegister').onclick=async()=>{
  try{
    const r=await fetch(state.base+'/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:username.value,email:email.value,password:password.value})});
    if(r.ok){authStatus.textContent='注册成功';authStatus.className='ok'} else {authStatus.textContent='注册失败';authStatus.className='err'}
  }catch{authStatus.textContent='注册异常';authStatus.className='err'}
};
document.getElementById('btnLogin').onclick=async()=>{
  try{
    const r=await fetch(state.base+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:username.value,password:password.value})});
    if(!r.ok){authStatus.textContent='登录失败';authStatus.className='err';return}
    const d=await r.json(); state.token=d.token; authStatus.textContent='已登录'; authStatus.className='ok';
  }catch{authStatus.textContent='登录异常';authStatus.className='err'}
};
async function listTransactions(){
  try{
    const r=await fetch(state.base+'/sync/transactions',{headers:{'Authorization':'Bearer '+state.token}});
    if(!r.ok){txTbody.innerHTML='<tr><td colspan="5">拉取失败</td></tr>';return}
    const arr=await r.json();
    txTbody.innerHTML=arr.map(t=>`<tr><td>${t.type||''}</td><td>${t.amount||''}</td><td>${t.categoryId||''}</td><td>${(t.description||'').replace(/</g,'&lt;')}</td><td>${t.date||''}</td></tr>`).join('');
  }catch{txTbody.innerHTML='<tr><td colspan="5">拉取异常</td></tr>'}
}
document.getElementById('btnPull').onclick=()=>{listTransactions()};
document.getElementById('btnPush').onclick=async()=>{
  try{
    const rows=[{type:'EXPENSE',amount:100.0,categoryId:'food',description:'示例支出',date:new Date().toISOString()}];
    const r=await fetch(state.base+'/sync/transactions/upload',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.token},body:JSON.stringify(rows)});
    if(r.ok){listTransactions()}
  }catch{}
};
document.getElementById('btnUploadArea').onclick=async()=>{
  try{
    const text=document.getElementById('uploadArea').value.trim();
    if(!text) return;
    const rows=JSON.parse(text);
    const r=await fetch(state.base+'/sync/transactions/upload',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.token},body:JSON.stringify(rows)});
    if(r.ok){listTransactions()}
  }catch{}
};
</script>
</body>
</html>

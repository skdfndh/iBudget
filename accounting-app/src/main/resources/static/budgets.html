<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>预算 · iBudget</title>
<style>
:root{--bg:#f7f8f9;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#0a84ff;--warn:#d33}
[data-theme="dark"]{--bg:#0b0e11;--card:#12151a;--text:#e5e7eb;--muted:#94a3b8;--line:#2a2f37;--accent:#0a84ff;--warn:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,system-ui}
.container{max-width:1080px;margin:0 auto;padding:24px}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
.nav a{color:var(--muted);text-decoration:none;margin-left:12px}
.surface{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
.section-title{display:flex;align-items:center;gap:8px;margin:0 0 12px 0;font-size:16px;font-weight:600}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
label{font-size:12px;color:var(--muted)}
input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
input:focus{border-color:var(--accent)}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-weight:600;color:var(--muted);text-align:left;padding:8px 10px}
.table td{background:#fff;border:1px solid var(--line);border-left:none;border-right:none;padding:12px 10px}
.table tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
.table tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
.bar{height:8px;border-radius:999px;background:linear-gradient(90deg,#0a84ff,#71b6ff);}
.usage{display:flex;align-items:center;gap:10px}
.alert{color:var(--warn);font-size:13px}
@media (max-width:768px){.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>iBudget</div>
    <div class="nav">
      <a href="/transactions.html">账目</a>
      <a href="/budgets.html">预算</a>
      <a href="/trends.html">趋势</a>
      <a href="/charts.html">图表</a>
      <a href="/login.html">切换账号</a>
      <a href="#" id="themeToggle">暗色</a>
    </div>
  </div>

  <div class="surface" style="margin-bottom:16px">
    <div class="section-title">月度预算设置</div>
    <div class="grid-2">
      <div><label>年份</label><input id="bdYear" type="number"></div>
      <div><label>月份</label><input id="bdMonth" type="number" min="1" max="12"></div>
      <div><label>分类（留空表示总预算）</label><input id="bdCategory"></div>
      <div><label>预算金额</label><input id="bdAmount" type="number" step="0.01"></div>
    </div>
    <div style="margin-top:12px">
      <button class="btn btn-primary" id="btnSetBudget">设置预算</button>
    </div>
  </div>

  <div class="surface" style="margin-bottom:16px">
    <div class="section-title">预算列表与智能提醒</div>
    <table class="table">
      <thead><tr><th>分类</th><th>金额</th><th>年月</th><th>使用率</th><th>提醒</th><th>操作</th></tr></thead>
      <tbody id="bdTbody"></tbody>
    </table>
  </div>
</div>

<script>
const savedTheme=localStorage.getItem('theme')||'light'
document.documentElement.dataset.theme=savedTheme
document.getElementById('themeToggle').onclick=(e)=>{e.preventDefault();const t=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=t;localStorage.setItem('theme',t)}
const base='/api'
const token=localStorage.getItem('jwt'); if(!token){location.href='/login.html'}
const bdYear=document.getElementById('bdYear')
const bdMonth=document.getElementById('bdMonth')
const bdCategory=document.getElementById('bdCategory')
const bdAmount=document.getElementById('bdAmount')
const bdTbody=document.getElementById('bdTbody')

async function fetchJSON(url,opts){
  const r=await fetch(url,{...opts,headers:{...(opts&&opts.headers||{}),'Content-Type':'application/json','Authorization':'Bearer '+token}})
  if(!r.ok) throw new Error('http '+r.status)
  return r.status===204?null:await r.json()
}

function nowYM(){const d=new Date(); return {year:d.getFullYear(),month:d.getMonth()+1}}
const nym=nowYM(); bdYear.value=nym.year; bdMonth.value=nym.month

document.getElementById('btnSetBudget').onclick=async()=>{
  const payload={year:parseInt(bdYear.value),month:parseInt(bdMonth.value),categoryId:(bdCategory.value||null),amount:parseFloat(bdAmount.value||'0')}
  await fetchJSON(base+'/budgets',{method:'POST',body:JSON.stringify(payload)})
  loadBudgets();
  try{localStorage.setItem('ledgerLastUpdate', String(Date.now()))}catch{}
}

async function usageInfo(userBudget){
  const q=new URLSearchParams({year:userBudget.year,month:userBudget.month}); if(userBudget.categoryId) q.set('categoryId',userBudget.categoryId)
  return await fetchJSON(base+'/budgets/usage?'+q.toString())
}

async function loadBudgets(){
  try{
    const arr=await fetchJSON(base+'/budgets')
    const rows = await Promise.all(arr.map(async b=>{
      const u=await usageInfo(b)
      const ratePct=Math.round((u.rate||0)*100)
      const alert=u.over?`<span class='alert'>超额 ${u.overAmount.toFixed(2)}</span>`:''
      return `<tr>
        <td>${b.categoryId||'总预算'}</td>
        <td style='text-align:right'>${(b.amount||0).toFixed(2)}</td>
        <td>${b.year}-${String(b.month).padStart(2,'0')}</td>
        <td class='usage'><div style='flex:1;background:#e5e7eb;border-radius:999px'><div class='bar' style='width:${ratePct}%' ></div></div><span>${ratePct}%</span></td>
        <td>${alert}</td>
        <td><button class='btn' data-id='${b.id}' data-action='del'>删除</button></td>
      </tr>`
    }))
    bdTbody.innerHTML=rows.join('')
  }catch{bdTbody.innerHTML='<tr><td colspan="6">加载失败</td></tr>'}
}

bdTbody.onclick=async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return
  const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action')
  if(action==='del'){
    await fetch(base+'/budgets/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}})
    loadBudgets();
    try{localStorage.setItem('ledgerLastUpdate', String(Date.now()))}catch{}
  }
}

loadBudgets()
</script>
</body>
</html>

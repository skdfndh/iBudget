<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>é¢„ç®— Â· iBudget</title>
    <style>
        :root{--bg:#f7f8f9;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#0a84ff;--warn:#d33}
        [data-theme="dark"]{--bg:#0f172a;--card:#1e293b;--text:#f8fafc;--muted:#94a3b8;--line:#334155;--accent:#38bdf8;--warn:#ef4444}
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,system-ui}
        .container{max-width:1080px;margin:0 auto;padding:24px}
        .header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
        .nav a{color:var(--muted);text-decoration:none;margin-left:12px}
        .surface{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 1px 2px rgba(15,23,42,.04);color:var(--text);}
        .section-title{display:flex;align-items:center;gap:8px;margin:0 0 12px 0;font-size:16px;font-weight:600;color:var(--text);}
        .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
        label{font-size:12px;color:var(--muted);font-weight:600}
        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:var(--text);outline:none}
        [data-theme="dark"] input,[data-theme="dark"] select{background:var(--bg)}
        input:focus,select:focus{border-color:var(--accent)}
        .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
        [data-theme="dark"] .btn{background:var(--card)}
        .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
        .toggle-group{display:flex;gap:0;border-radius:12px;overflow:hidden;border:1px solid var(--line);width:fit-content;height:44px}
        .toggle-btn{flex:1;padding:0 24px;background:var(--bg);color:var(--muted);border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s ease;border-right:1px solid var(--line);display:flex;align-items:center;justify-content:center;min-width:120px}
        .toggle-btn:last-child{border-right:none}
        .toggle-btn.active{background:var(--accent);color:#fff;box-shadow:inset 0 0 0 2px var(--accent)}
        .toggle-btn:hover:not(.active){background:var(--card);color:var(--text)}
        .table{width:100%;border-collapse:separate;border-spacing:0 8px}
        .table th{font-weight:600;color:var(--muted);text-align:left;padding:8px 10px}
        .table td{background:var(--card);border:1px solid var(--line);border-left:none;border-right:none;padding:12px 10px}
        .table tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
        .table tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
        .usage{display:flex;align-items:center;gap:10px;height:20px}
        .bar-bg{flex:1;background:var(--bg);border-radius:999px;height:8px;overflow:hidden;border:1px solid var(--line)}
        .bar{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),#71b6ff)}
        .alert{color:var(--warn);font-size:13px;font-weight:bold}
        @media (max-width:768px){.grid-2{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="font-weight:800;font-size:1.2rem">iBudget</div>
        <div class="nav">
            <a href="/transactions.html">è´¦ç›®</a>
            <a href="/budgets.html">é¢„ç®—</a>
            <a href="/trends.html">è¶‹åŠ¿</a>
            <a href="/charts.html">å›¾è¡¨</a>
            <a href="/login.html">åˆ‡æ¢è´¦å·</a>
            <a href="#" id="themeToggle" style="color:var(--accent);font-weight:800">åˆ‡æ¢ä¸»é¢˜</a>
        </div>
    </div>

    <div class="surface" style="margin-bottom:16px">
        <div class="section-title">é¢„ç®—è®¾ç½®</div>

        <div style="margin-bottom:16px">
            <div class="toggle-group">
                <button class="toggle-btn active" data-type="monthly">æœˆåº¦é¢„ç®—</button>
                <button class="toggle-btn" data-type="period">å‘¨æœŸå‹é¢„ç®—</button>
            </div>
        </div>

        <div id="monthlyForm">
            <div class="grid-2">
                <div><label>å¹´ä»½</label><input id="bdYear" type="number"></div>
                <div><label>æœˆä»½</label><input id="bdMonth" type="number" min="1" max="12"></div>
                <div><label>åˆ†ç±»(ç•™ç©ºè¡¨ç¤ºæ€»é¢„ç®—)</label><input id="bdCategory"></div>
                <div><label>é¢„ç®—é‡‘é¢</label><input id="bdAmount" type="number" min="0" step="1"></div>
            </div>
            <div style="margin-top:12px">
                <button class="btn btn-primary" id="btnSetBudget">è®¾ç½®é¢„ç®—</button>
            </div>
        </div>

        <div id="periodForm" style="display:none">
            <div class="grid-2">
                <div><label>å¼€å§‹æ—¥æœŸ</label><input id="pdStartDate" type="date"></div>
                <div><label>åˆ†ç±»(ç•™ç©ºè¡¨ç¤ºæ€»é¢„ç®—)</label><input id="pdCategory"></div>
                <div>
                    <label>å‘¨æœŸå•ä½</label>
                    <select id="pdUnit">
                        <option value="DAYS">å¤©</option>
                        <option value="WEEKS">å‘¨</option>
                        <option value="MONTHS" selected>æœˆ</option>
                        <option value="YEARS">å¹´</option>
                    </select>
                </div>
                <div><label>å‘¨æœŸæ•°é‡</label><input id="pdCount" type="number" min="1" value="1"></div>
                <div><label>é¢„ç®—é‡‘é¢</label><input id="pdAmount" type="number" min="0" step="1"></div>
            </div>
            <div style="margin-top:12px">
                <button class="btn btn-primary" id="btnSetPeriodBudget">åˆ›å»ºå‘¨æœŸå‹é¢„ç®—</button>
            </div>
        </div>
    </div>

    <div class="surface" style="margin-bottom:16px">
        <div class="section-title">é¢„ç®—åˆ—è¡¨ä¸æ™ºèƒ½åˆ†æ</div>
        <table class="table">
            <thead><tr><th>åˆ†ç±»</th><th>é¢„ç®—é‡‘é¢</th><th>å‘¨æœŸ</th><th>å·²æ¶ˆè´¹</th><th>å‰©ä½™</th><th>æ—¥å‡é¢„ç®—</th><th>æ—¥å‡å®é™…</th><th>ä½¿ç”¨ç‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="bdTbody"></tbody>
        </table>
    </div>
</div>

<script>
    const savedTheme=localStorage.getItem('theme')||'light'
    document.documentElement.dataset.theme=savedTheme
    document.getElementById('themeToggle').onclick=(e)=>{e.preventDefault();const t=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=t;localStorage.setItem('theme',t)}
    const base='/api'; const token=localStorage.getItem('jwt');
    if(!token){console.error('æœªç™»å½•,è·³è½¬ç™»å½•é¡µ');location.href='/login.html'}

    // æœˆåº¦é¢„ç®—å…ƒç´ 
    const bdYear=document.getElementById('bdYear')
    const bdMonth=document.getElementById('bdMonth')
    const bdCategory=document.getElementById('bdCategory')
    const bdAmount=document.getElementById('bdAmount')

    // å‘¨æœŸå‹é¢„ç®—å…ƒç´ 
    const pdStartDate=document.getElementById('pdStartDate')
    const pdCategory=document.getElementById('pdCategory')
    const pdUnit=document.getElementById('pdUnit')
    const pdCount=document.getElementById('pdCount')
    const pdAmount=document.getElementById('pdAmount')

    const bdTbody=document.getElementById('bdTbody')
    const monthlyForm=document.getElementById('monthlyForm')
    const periodForm=document.getElementById('periodForm')

    // --- é‡‘é¢è¾“å…¥é€»è¾‘ä¼˜åŒ– ---
    const handleAmountInput = (input) => {
        // å¤±å»ç„¦ç‚¹æ—¶ï¼šå¤„ç†è´Ÿæ•°å’Œä¿ç•™ä¸¤ä½å°æ•°
        input.addEventListener('blur', () => {
            let val = parseFloat(input.value);
            if (isNaN(val) || val < 0) {
                input.value = "0";
            } else {
                input.value = val.toFixed(2);
            }
            updateStep(input);
        });

        // è¾“å…¥æ—¶ï¼šåŠ¨æ€è°ƒæ•´æ­¥é•¿
        const updateStep = (el) => {
            const valStr = el.value.toString();
            if (!valStr || !valStr.includes('.')) {
                el.step = "1";
                return;
            }
            const decimalPart = valStr.split('.')[1];
            if (decimalPart.length === 1) {
                el.step = "0.1";
            } else if (decimalPart.length >= 2) {
                el.step = "0.01";
            }
        };

        input.addEventListener('input', () => updateStep(input));
    };

    handleAmountInput(bdAmount);
    handleAmountInput(pdAmount);
    // -----------------------

    // é¢„ç®—ç±»å‹åˆ‡æ¢
    document.querySelectorAll('.toggle-btn').forEach(btn=>{
        btn.onclick=()=>{
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'))
            btn.classList.add('active')

            // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
            const type=btn.getAttribute('data-type')
            if(type==='monthly'){
                monthlyForm.style.display='block'
                periodForm.style.display='none'
            }else{
                monthlyForm.style.display='none'
                periodForm.style.display='block'
            }
        }
    })

    async function fetchJSON(url,opts){
        const r=await fetch(url,{...opts,headers:{...(opts&&opts.headers||{}),'Content-Type':'application/json','Authorization':'Bearer '+token}})
        if(r.status === 403){
            console.error('èº«ä»½éªŒè¯å¤±è´¥(403),tokenå¯èƒ½å·²è¿‡æœŸ')
            alert('ç™»å½•å·²è¿‡æœŸ,è¯·é‡æ–°ç™»å½•')
            localStorage.removeItem('jwt')
            location.href='/login.html'
            throw new Error('èº«ä»½éªŒè¯å¤±è´¥,è¯·é‡æ–°ç™»å½•')
        }
        if(!r.ok) throw new Error('http '+r.status);
        return r.status===204?null:await r.json()
    }

    function nowYM(){const d=new Date(); return {year:d.getFullYear(),month:d.getMonth()+1}}
    const nym=nowYM(); bdYear.value=nym.year; bdMonth.value=nym.month

    // è®¾ç½®å‘¨æœŸå‹é¢„ç®—é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today=new Date().toISOString().split('T')[0]
    pdStartDate.value=today

    // æœˆåº¦é¢„ç®—è®¾ç½®
    document.getElementById('btnSetBudget').onclick=async()=>{
        try{
            const payload={year:parseInt(bdYear.value),month:parseInt(bdMonth.value),categoryId:(bdCategory.value||null),amount:parseFloat(bdAmount.value||'0')}
            await fetchJSON(base+'/budgets',{method:'POST',body:JSON.stringify(payload)})
            alert('âœ… æœˆåº¦é¢„ç®—è®¾ç½®æˆåŠŸ')
            loadBudgets()
        }catch(e){
            alert('âŒ åˆ›å»ºå¤±è´¥: '+e.message)
        }
    }

    // å‘¨æœŸå‹é¢„ç®—åˆ›å»º
    document.getElementById('btnSetPeriodBudget').onclick=async()=>{
        try{
            const userId=JSON.parse(atob(token.split('.')[1])).sub
            const startDate=pdStartDate.value
            if(!startDate){alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ');return}

            const amount = parseFloat(pdAmount.value||'0')
            if(amount <= 0){alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢„ç®—é‡‘é¢');return}

            const payload={
                userId,
                categoryId:pdCategory.value||null,
                amount,
                startDate,
                periodUnit:pdUnit.value,
                periodCount:parseInt(pdCount.value||'1'),
                year:parseInt(startDate.split('-')[0]),
                month:parseInt(startDate.split('-')[1])
            }
            console.log('åˆ›å»ºå‘¨æœŸå‹é¢„ç®—:', payload)
            const result = await fetchJSON(base+'/budgets',{method:'POST',body:JSON.stringify(payload)})
            console.log('åˆ›å»ºæˆåŠŸ:', result)
            alert('âœ… å‘¨æœŸå‹é¢„ç®—åˆ›å»ºæˆåŠŸ')
            // æ¸…ç©ºè¡¨å•
            pdAmount.value=''
            pdCategory.value=''
            loadBudgets()
        }catch(e){
            console.error('åˆ›å»ºå¤±è´¥:', e)
            alert('âŒ åˆ›å»ºå¤±è´¥: '+e.message)
        }
    }

    async function usageInfo(userBudget){
        const q=new URLSearchParams({year:userBudget.year,month:userBudget.month}); if(userBudget.categoryId) q.set('categoryId',userBudget.categoryId)
        return await fetchJSON(base+'/budgets/usage?'+q.toString())
    }

    // è·å–é¢„ç®—ç»Ÿè®¡æ•°æ®
    async function getStats(budgetId){
        try{
            return await fetchJSON(base+'/budgets/stats/'+budgetId)
        }catch(e){
            console.error('è·å–ç»Ÿè®¡å¤±è´¥:',e)
            return null
        }
    }

    // æ ¼å¼åŒ–å‘¨æœŸæ˜¾ç¤º
    function formatPeriod(b){
        if(b.startDate && b.periodUnit){
            const unitMap={DAYS:'å¤©',WEEKS:'å‘¨',MONTHS:'æœˆ',YEARS:'å¹´'}
            const unit=unitMap[b.periodUnit]||b.periodUnit
            return `${b.startDate} èµ· ${b.periodCount}${unit}`
        }
        return `${b.year}-${String(b.month).padStart(2,'0')}`
    }

    async function loadBudgets(){
        try{
            const arr=await fetchJSON(base+'/budgets')
            if(!arr || arr.length===0){
                bdTbody.innerHTML='<tr><td colspan="10" style="text-align:center;color:var(--muted)">æš‚æ— é¢„ç®—æ•°æ®,è¯·å…ˆåˆ›å»ºé¢„ç®—</td></tr>'
                return
            }

            const rows = await Promise.all(arr.map(async b=>{
                let ratePct=0, statusHtml='', spent=0, remaining=0, avgBudget='', avgActual=''

                if(b.startDate && b.periodUnit){
                    // å‘¨æœŸå‹é¢„ç®— - ä½¿ç”¨ç»Ÿè®¡åˆ†æ
                    const stats=await getStats(b.id)
                    if(stats){
                        spent = stats.amountSpent
                        remaining = stats.remaining
                        ratePct=Math.round((stats.amountSpent/b.amount)*100)
                        avgBudget = `Â¥${stats.avgPerDayBudget.toFixed(2)}`
                        avgActual = `Â¥${stats.avgPerDayActual.toFixed(2)}`

                        if(stats.willBeOverspentByAvg){
                            statusHtml=`<span class='alert'>âš ï¸ é¢„æµ‹è¶…æ”¯ Â¥${Math.abs(stats.projectedRemainingByAvgSoFar).toFixed(2)}</span>`
                        }else if(stats.remaining<0){
                            statusHtml=`<span class='alert'>å·²è¶…é¢ Â¥${Math.abs(stats.remaining).toFixed(2)}</span>`
                        }else if(ratePct>=80){
                            statusHtml=`<span style='color:var(--warn)'>é¢„è­¦ ${ratePct}%</span>`
                        }else{
                            statusHtml=`<span style='color:var(--accent)'>âœ“ å¥åº·</span>`
                        }
                    }
                }else{
                    // æœˆåº¦é¢„ç®— - ä½¿ç”¨åŸæœ‰é€»è¾‘
                    try{
                        const u=await usageInfo(b)
                        spent = u.rate * b.amount
                        remaining = b.amount - spent
                        ratePct=Math.round((u.rate||0)*100)

                        // è®¡ç®—æœˆåº¦é¢„ç®—çš„æ—¥å‡å€¼(å‡è®¾30å¤©)
                        avgBudget = `Â¥${(b.amount/30).toFixed(2)}`
                        avgActual = `Â¥${(spent/30).toFixed(2)}`

                        if(u.over){
                            statusHtml=`<span class='alert'>å·²è¶…é¢ Â¥${u.overAmount.toFixed(2)}</span>`
                        }else if(ratePct>=80){
                            statusHtml=`<span style='color:var(--warn)'>é¢„è­¦ ${ratePct}%</span>`
                        }else{
                            statusHtml=`<span style='color:var(--accent)'>âœ“ æ­£å¸¸</span>`
                        }
                    }catch(e){
                        console.error('è·å–é¢„ç®—ä½¿ç”¨ç‡å¤±è´¥:', e)
                    }
                }

                return `<tr>
        <td>${b.categoryId||'æ€»é¢„ç®—'}</td>
        <td style='text-align:right;font-weight:bold'>Â¥${(b.amount||0).toFixed(2)}</td>
        <td>${formatPeriod(b)}</td>
        <td style='text-align:right;font-weight:600;color:var(--accent)'>Â¥${spent.toFixed(2)}</td>
        <td style='text-align:right;font-weight:600;color:${remaining>=0?'var(--text)':'var(--warn)'}'>Â¥${remaining.toFixed(2)}</td>
        <td style='text-align:right;font-size:13px'>${avgBudget}</td>
        <td style='text-align:right;font-size:13px;font-weight:600'>${avgActual}</td>
        <td><div class='usage'><div class='bar-bg'><div class='bar' style='width:${Math.min(ratePct,100)}%'></div></div><span style='font-size:12px;min-width:35px'>${ratePct}%</span></div></td>
        <td>${statusHtml}</td>
        <td>
            ${b.startDate?`<button class='btn' data-id='${b.id}' data-action='detail'>è¯¦æƒ…</button> `:''}
            <button class='btn' data-id='${b.id}' data-action='del'>åˆ é™¤</button>
        </td>
      </tr>`
            }))
            bdTbody.innerHTML=rows.join('')
        }catch(e){
            console.error('åŠ è½½é¢„ç®—å¤±è´¥:', e)
            bdTbody.innerHTML='<tr><td colspan="10" style="text-align:center;color:var(--warn)">åŠ è½½å¤±è´¥: '+e.message+'</td></tr>'
        }
    }

    bdTbody.onclick=async(e)=>{
        const btn=e.target.closest('button'); if(!btn) return
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action')
        if(action==='del'){
            await fetch(base+'/budgets/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}})
            loadBudgets()
        }else if(action==='detail'){
            showBudgetDetail(id)
        }
    }

    // æ˜¾ç¤ºé¢„ç®—è¯¦ç»†ç»Ÿè®¡
    async function showBudgetDetail(budgetId){
        const stats=await getStats(budgetId)
        if(!stats||!stats.budget.startDate){
            alert('è¯¥é¢„ç®—æš‚æ— è¯¦ç»†ç»Ÿè®¡æ•°æ®')
            return
        }

        const s=stats
        let msg=`ğŸ“Š é¢„ç®—ç»Ÿè®¡åˆ†æ\n\n`
        msg+=`ğŸ“… å‘¨æœŸ: ${s.budget.startDate} è‡³ ${s.budget.endDate}\n`
        msg+=`ğŸ’° æ€»é¢„ç®—: Â¥${s.budget.amount.toFixed(2)}\n`
        msg+=`âœ… å·²æ¶ˆè´¹: Â¥${s.amountSpent.toFixed(2)}\n`
        msg+=`ğŸ’µ å‰©ä½™: Â¥${s.remaining.toFixed(2)}\n\n`
        msg+=`ğŸ“ˆ æ—¥å‡é¢„ç®—: Â¥${s.avgPerDayBudget.toFixed(2)}/å¤©\n`
        msg+=`ğŸ“‰ å®é™…æ—¥å‡: Â¥${s.avgPerDayActual.toFixed(2)}/å¤©\n`
        msg+=`â±ï¸ å·²ç»è¿‡ ${s.daysElapsed}/${s.totalDays} å¤©\n\n`

        if(s.willBeOverspentByAvg){
            msg+=`âš ï¸ è¶…æ”¯é¢„è­¦: æŒ‰å½“å‰é€Ÿç‡ï¼Œé¢„è®¡æ€»æ¶ˆè´¹ Â¥${s.projectedTotalByAvgSoFar.toFixed(2)}\n`
            msg+=`   é¢„è®¡è¶…æ”¯ Â¥${Math.abs(s.projectedRemainingByAvgSoFar).toFixed(2)}\n\n`
        }else{
            msg+=`âœ… é¢„ç®—å¥åº·: æŒ‰å½“å‰é€Ÿç‡ï¼Œé¢„è®¡å‰©ä½™ Â¥${s.projectedRemainingByAvgSoFar.toFixed(2)}\n\n`
        }

        if(s.last7DaysSpent>0){
            msg+=`ğŸ“† è¿‘7å¤©æ¶ˆè´¹: Â¥${s.last7DaysSpent.toFixed(2)}\n`
        }
        if(s.last30DaysSpent>0){
            msg+=`ğŸ“† è¿‘30å¤©æ¶ˆè´¹: Â¥${s.last30DaysSpent.toFixed(2)}\n`
        }

        alert(msg)
    }

    loadBudgets()
</script>
</body>
</html>